---
title: "Relação dentre distrbuição e dependência"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Relação dentre distrbuição e dependência}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(vet)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(scales)
library(patchwork)
```

```{r}
tab_plot <- tab_amostra_dependente |> 
  filter(as.character(vl_correlacao) %in% c("0.3", "0.7")) |> 
  filter(cd_marginais %in% c("unif - unif", "norm - norm", "sn_pos - sn_pos", "sn_neg - sn_neg")) |> 
  group_by(cd_var, cd_marginais) |>
  mutate(id = row_number()) |>
  ungroup() |>
  select(-nm_var) |>
  spread(cd_var, vl_amostra) 

plt_density <- tab_plot |> 
  ggplot(aes(custo , producao)) +
  geom_density2d_filled(
    aes(fill = after_stat(level)),
    alpha = 0.8,
    contour_var = "ndensity", show.legend = FALSE
  ) +
  facet_grid(
    vl_correlacao ~ cd_marginais,
    labeller = labeller(
      cd_marginais = \(x) str_to_upper(str_replace_all(x, "_", " ")),
      vl_correlacao = \(x) paste("Correlação", formatC(as.numeric(x), decimal.mark = ","))
    )
  ) +
  labs(
    x = expression(paste("Custo de formação ", "(R$ ", "ha"^"-1", ")")),
    y = expression(Produção~de~madeira~(m^3~ha^-1))
  ) +
  scale_x_continuous(breaks = seq(0, 30000, 4000), labels = label_number_auto()) +
  scale_y_continuous(breaks = seq(40, 500, 50)) +
  #scale_fill_viridis_c('Quantil', labels = percent(seq(0.1, 1, 0.1)), guide = guide_colourbar()) +
  theme_bw() +
  theme(
    text = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    legend.position = "top", legend.justification = "left"
  )
```

```{r}
get_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

plt_legend <- {tibble(x = 1:11, y = seq(0, 1, 0.1)) |> 
  ggplot(aes(x, y, color = y)) + 
    geom_point() +
    theme(legend.position = "top", legend.justification = "left", legend.margin=margin(l = 1.65, unit='cm') ) +
    scale_color_viridis_c("Densidade   ") +
    guides(color = guide_colorbar(barwidth = 10, barheight = 1, ticks.colour = "black"))
  } |> 
  get_legend()
```


```{r}
#| label: fig-contour-custo-producao-dist
#| fig-width: 8
#| fig-height: 4.5
#| out-width: 100%
#| dpi: 500
#| fig-cap: "Distribuição de probabilidade"

plot_spacer() +
  plt_legend +
  plt_density +
  plot_layout(nrow = 3, heights = c(.001, 0.1, 1))
```



